<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Reconocimiento Facial</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Alertas Flash -->
    <div style="position: absolute; top: 20px; right: 20px; z-index: 2000; width: 300px;">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    </div>

    <header>
        <h1>Dashboard Museo</h1>
        <div class="user-bar">
            <span>Operador: <strong>{{ current_user.username }}</strong></span>
            <a href="{{ url_for('logout') }}" class="btn-logout">Cerrar Sesi칩n</a>
        </div>
    </header>

    <div class="main-container">
        <!-- Columna Izquierda -->
        <div class="column">
            <div class="card">
                <h2>C치mara Principal</h2>
                <div class="camera-wrapper">
                    <img src="{{ url_for('video_feed') }}" class="camera-feed" alt="Video Feed">
                </div>
            </div>
            
            <div class="card">
                <h2>Afluencia Semanal</h2>
                <div style="height: 250px;">
                    <canvas id="chartSemana"></canvas>
                </div>
            </div>
        </div>

        <!-- Columna Derecha -->
        <div class="column">
            <div class="card">
                <h2>Estad칤sticas y Registros</h2>
                
                <!-- Resumen de n칰meros -->
                <div class="summary-grid">
                    <div class="summary-item">
                        <h3>Total Hist칩rico</h3>
                        <p id="total-registros">{{ total_items }}</p> 
                    </div>
                    <div class="summary-item">
                        <h3>Visitas este Mes</h3>
                        <p id="nuevos-mes">{{ registros_mes }}</p>
                    </div>
                </div>
                
                <!-- Filtros para gr치fico de tendencia -->
                <div class="filter-section">
                    <label>Desde:</label>
                    <input type="date" id="startDate">
                    <label>Hasta:</label>
                    <input type="date" id="endDate">
                    <button class="btn-filter" onclick="loadCharts()">Actualizar Gr치fico</button>
                </div>
                
                <!-- Gr치fico de Tendencia -->
                <div style="height: 200px; margin-bottom: 20px;">
                    <canvas id="chartTendencia"></canvas>
                </div>

                <!-- Botones de Exportaci칩n -->
                <div class="export-container">
                    <a href="{{ url_for('export_csv') }}" class="btn-export btn-csv">游늯 Descargar CSV</a>
                    <a href="{{ url_for('export_excel') }}" class="btn-export btn-excel">游늵 Descargar Excel</a>
                </div>

                <!-- Tabla de Datos -->
                <table>
                    <thead>
                        <tr>
                            <th>ID Visitante</th>
                            <th>Fecha y Hora</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-registros">
                        {% for rostro in rostros %}
                        <tr>
                            <td>#{{ rostro.id }}</td>
                            <td>{{ rostro.timestamp }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="2" style="text-align:center;">No hay registros recientes.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <!-- Paginaci칩n -->
                {% if total_pages > 1 %}
                <div class="pagination">
                    {% if page > 1 %}
                    <a href="{{ url_for('dashboard', page=page-1) }}">&laquo; Anterior</a>
                    {% endif %}
                    <span class="current">P치gina {{ page }}</span>
                    {% if page < total_pages %}
                    <a href="{{ url_for('dashboard', page=page+1) }}">Siguiente &raquo;</a>
                    {% endif %}
                </div>
                {% endif %}

            </div>
        </div>
    </div>

    <script>
        // Configuraci칩n visual de los gr치ficos
        Chart.defaults.color = '#9fa6b2';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';
        Chart.defaults.font.family = "'Inter', sans-serif";

        let chartSemanaInstance = null;
        let chartTendenciaInstance = null;

        // Funci칩n para cargar/filtrar gr치ficos
        function loadCharts() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            let url = '/api/charts_data';
            if (start && end) {
                url += `?start=${start}&end=${end}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    renderChartSemana(data.semana_labels, data.semana_data);
                    renderChartTendencia(data.tendencia_labels, data.tendencia_data);
                })
                .catch(err => console.error("Error cargando gr치ficos:", err));
        }

        // Renderizado de Gr치fico Semanal (Barras)
        function renderChartSemana(labels, data) {
            const ctx = document.getElementById('chartSemana').getContext('2d');
            if (chartSemanaInstance) chartSemanaInstance.destroy();

            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, '#7e3af2');
            gradient.addColorStop(1, '#4c1d95');

            chartSemanaInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Visitas',
                        data: data,
                        backgroundColor: gradient,
                        borderRadius: 5,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } } }
                }
            });
        }

        // Renderizado de Gr치fico Tendencia (L칤nea)
        function renderChartTendencia(labels, data) {
            const ctx = document.getElementById('chartTendencia').getContext('2d');
            if (chartTendenciaInstance) chartTendenciaInstance.destroy();

            chartTendenciaInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tendencia',
                        data: data,
                        borderColor: '#0e9f6e',
                        backgroundColor: 'rgba(14, 159, 110, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } } }
                }
            });
        }

        // Funci칩n unificada para actualizar Tabla y Contadores
        function updateDashboard() {
            const params = new URLSearchParams(window.location.search);
            const page = params.get('page') || 1;

            fetch(`/api/dashboard_data?page=${page}`)
                .then(response => response.json())
                .then(data => {
                    // Actualizar n칰meros grandes
                    document.getElementById('total-registros').textContent = data.total_items;
                    document.getElementById('nuevos-mes').textContent = data.registros_mes;

                    // Actualizar Tabla
                    const tablaBody = document.getElementById('tabla-registros');
                    tablaBody.innerHTML = '';

                    if (data.rostros.length === 0) {
                        tablaBody.innerHTML = '<tr><td colspan="2" style="text-align:center;">No hay registros recientes.</td></tr>';
                    } else {
                        data.rostros.forEach(rostro => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>#${rostro.id}</td>
                                <td>${rostro.timestamp}</td>
                            `;
                            tablaBody.appendChild(tr);
                        });
                    }
                })
                .catch(error => console.error('Error al actualizar el dashboard:', error));
        }

        // Inicializaci칩n
        document.addEventListener("DOMContentLoaded", () => {
            loadCharts();
            setInterval(updateDashboard, 5000);
        });
    </script>
</body>
</html>